<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CRAFTY: UNIVERSAL EDITION</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { 
            --bg: #f0f2f5; --primary: #4a90e2; --accent: #ff4757; --glass: rgba(255, 255, 255, 0.9);
            --safe-bottom: env(safe-area-inset-bottom, 20px); 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        /* Navigation */
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; top:0; left:0; }
        .active { display: flex; }

        /* --- RESPONSIVE LAYOUT LOGIC --- */
        
        /* DESKTOP (Side Sidebar) */
        @media (min-width: 768px) {
            #board { position: absolute; top: 0; left: 0; right: 300px; bottom: 0; background: white; }
            #inventory { position: absolute; top: 0; right: 0; width: 300px; height: 100%; background: #f8f9fa; border-left: 2px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; gap: 10px; z-index: 1000; }
            .inv-item { width: 100%; text-align: left; }
        }

        /* MOBILE (Bottom Drawer) */
        @media (max-width: 767px) {
            #board { position: absolute; top: 0; left: 0; right: 0; bottom: calc(140px + var(--safe-bottom)); background: white; }
            #inventory { position: absolute; bottom: 0; left: 0; right: 0; height: calc(140px + var(--safe-bottom)); background: #f8f9fa; border-top: 2px solid #ddd; display: flex; flex-direction: row; overflow-x: auto; padding: 15px; gap: 12px; align-items: center; z-index: 1000; padding-bottom: var(--safe-bottom); }
            .inv-item { flex-shrink: 0; }
        }

        /* Elements */
        .item { position: absolute; padding: 12px 18px; background: white; border: 1px solid #ddd; border-radius: 25px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); font-size: 1.2rem; display: flex; align-items: center; gap: 8px; z-index: 10; white-space: nowrap; cursor: grab; user-select: none; }
        .item:active { cursor: grabbing; }
        .inv-item { padding: 10px 20px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
        .inv-item:hover { background: #eee; }
        .recipe-btn { font-size: 0.7rem; background: #eee; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; margin-left: 5px; color: #888; border: 1px solid #ddd; }

        /* UI Components */
        .menu-btn { width: 280px; padding: 18px; margin: 10px; font-size: 1.2rem; border: none; border-radius: 15px; cursor: pointer; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; }
        .special { background: var(--primary); color: white; }
        #goal-bar { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--glass); padding: 10px 25px; border-radius: 30px; border: 2px solid var(--accent); font-weight: bold; z-index: 100; }
        .corner-btn { position: fixed; z-index: 101; width: 50px; height: 50px; background: white; border-radius: 50%; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: 25px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Info</h2>
            <p id="modal-text"></p>
            <button class="menu-btn special" onclick="closeModal()">Close</button>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <h1>CRAFTY üß™</h1>
        <button class="menu-btn special" onclick="startSinglePlayer()">üïπÔ∏è Single Player</button>
        <button class="menu-btn" onclick="showScreen('screen-multi')">üë• Multiplayer Race</button>
        <div class="corner-btn" style="bottom: 20px; right:20px;" onclick="openInfo()">?</div>
    </div>

    <div id="screen-multi" class="screen">
        <h2 id="lobby-status">Lobby</h2>
        <input type="text" id="room-input" placeholder="Room Code" style="padding:15px; width:220px; border-radius:12px; border:1px solid #ccc; margin-bottom:15px; font-size:1.1rem;">
        <div id="lobby-actions">
            <button class="menu-btn special" onclick="setupLobby('host')">üè† Host Race</button>
            <button class="menu-btn" onclick="setupLobby('join')">üîë Join Room</button>
        </div>
        <div id="host-controls" style="display:none;">
            <button class="menu-btn special" onclick="triggerRaceStart()">üöÄ START RACE</button>
        </div>
        <button class="menu-btn" onclick="location.reload()">‚¨ÖÔ∏è Back</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="goal-bar" style="display:none;">TARGET: <span id="target-word">...</span></div>
        <div class="corner-btn" style="top: 20px; left:20px;" onclick="location.reload()">üè†</div>
        <div class="corner-btn" style="top: 20px; right:20px;" onclick="clearBoard()">üßπ</div>
        <div id="board"></div>
        <div id="inventory"></div>
    </div>

    <script>
        const ABLY_KEY = 'IX1oeA.YHFVAg:SzKEUf1q-Lvi5CQzI3BlCyhh2tX1fZBfxXtFyYu_-NY';
        let myDiscoveries = JSON.parse(localStorage.getItem('myCrafts')) || [
            {n:"Water",e:"üíß"}, {n:"Fire",e:"üî•"}, {n:"Earth",e:"üåç"}, {n:"Wind",e:"üí®"}
        ];
        let recipeBook = JSON.parse(localStorage.getItem('recipeBook')) || {};
        let isMultiplayer = false, targetGoal = "", ably, channel;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openInfo() {
            document.getElementById('modal-title').innerText = "How to Play";
            document.getElementById('modal-text').innerText = "Drag elements together to create new ones. Works on Desktop & Mobile!";
            document.getElementById('infoModal').style.display = 'flex';
        }

        function showRecipe(name) {
            const r = recipeBook[name];
            document.getElementById('modal-title').innerText = name;
            document.getElementById('modal-text').innerText = r ? `Recipe: ${r.i1} + ${r.i2}` : "Basic Element";
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('infoModal').style.display = 'none'; }

        function startSinglePlayer() {
            isMultiplayer = false;
            document.getElementById('goal-bar').style.display = 'none';
            showScreen('screen-game');
            updateInventoryUI();
        }

        async function setupLobby(role) {
            const code = document.getElementById('room-input').value;
            if (!code) return;
            ably = new Ably.Realtime(ABLY_KEY);
            channel = ably.channels.get('race-' + code);
            isMultiplayer = true;
            channel.subscribe('start-race', (msg) => {
                targetGoal = msg.data.goal;
                document.getElementById('target-word').innerText = msg.data.emoji + " " + targetGoal;
                showScreen('screen-game');
                document.getElementById('goal-bar').style.display = 'block';
                updateInventoryUI();
            });
            channel.subscribe('win', (msg) => {
                alert("üèÜ " + msg.data.winner + " WON!");
                location.reload();
            });
            if (role === 'host') {
                document.getElementById('lobby-actions').style.display = 'none';
                document.getElementById('host-controls').style.display = 'block';
            } else {
                showScreen('screen-game');
                document.getElementById('goal-bar').style.display = 'block';
            }
        }

        async function triggerRaceStart() {
            const res = await fetch('/api/craft', { method: 'POST', body: JSON.stringify({ item1: "Random", item2: "Goal" }) });
            const data = await res.json();
            channel.publish('start-race', { goal: data.n, emoji: data.e });
        }

        function updateInventoryUI() {
            const inv = document.getElementById('inventory');
            inv.innerHTML = '';
            myDiscoveries.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.innerHTML = `${item.e} ${item.n}`;
                div.onclick = () => createItem(item.n, item.e, 100, 100);
                inv.appendChild(div);
            });
        }

        function createItem(name, emoji, x, y, parents = null) {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<span>${emoji} ${name}</span><div class="recipe-btn" onclick="event.stopPropagation(); showRecipe('${name}')">i</div>`;
            div.style.left = x + 'px'; div.style.top = y + 'px';
            
            if (parents) { recipeBook[name] = parents; localStorage.setItem('recipeBook', JSON.stringify(recipeBook)); }
            
            if (!myDiscoveries.some(d => d.n === name)) {
                myDiscoveries.push({n: name, e: emoji});
                localStorage.setItem('myCrafts', JSON.stringify(myDiscoveries));
                updateInventoryUI();
            }

            if (isMultiplayer && name.toLowerCase() === targetGoal.toLowerCase()) {
                channel.publish('win', { winner: "A Rival Alchemist" });
            }

            // Universal Dragging (Mouse + Touch)
            let isDragging = false;
            const startDrag = (e) => { isDragging = true; div.style.zIndex = 1000; };
            const moveDrag = (e) => {
                if (!isDragging) return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                div.style.left = (clientX - 60) + 'px';
                div.style.top = (clientY - 25) + 'px';
                checkOverlap(div);
            };
            const endDrag = () => { isDragging = false; div.style.zIndex = 10; };

            div.onmousedown = startDrag;
            div.ontouchstart = startDrag;
            document.onmousemove = moveDrag;
            document.ontouchmove = (e) => { if(isDragging) e.preventDefault(); moveDrag(e); };
            document.onmouseup = endDrag;
            div.ontouchend = endDrag;

            document.getElementById('board').appendChild(div);
        }

        async function checkOverlap(active) {
            const items = document.querySelectorAll('.item');
            const r1 = active.getBoundingClientRect();
            for (let other of items) {
                if (other === active) continue;
                const r2 = other.getBoundingClientRect();
                if (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom)) {
                    const i1 = active.innerText.split(' ').slice(1).join(' ').replace('i','').trim();
                    const i2 = other.innerText.split(' ').slice(1).join(' ').replace('i','').trim();
                    active.remove(); other.remove();
                    const res = await fetch('/api/craft', { method: 'POST', body: JSON.stringify({ item1: i1, item2: i2 }) });
                    const data = await res.json();
                    createItem(data.n, data.e, r2.left, r2.top, {i1, i2});
                    break;
                }
            }
        }

        function clearBoard() { document.getElementById('board').innerHTML = ''; }
    </script>
</body>
</html>
