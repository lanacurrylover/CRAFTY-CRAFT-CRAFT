<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CRAFTY: ULTIMATE EDITION</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { 
            --bg: #f0f2f5; --primary: #4a90e2; --accent: #ff4757; --glass: rgba(255, 255, 255, 0.9);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px); 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); overflow: hidden; position: fixed; width: 100vw; height: 100vh; }
        
        /* Navigation & Screens */
        .screen { display: none; width: 100vw; height: 100vh; position: absolute; top:0; left:0; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); }
        .active { display: flex; }

        /* Board Layout */
        #board { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 1; outline: none; }
        
        /* Responsive Inventory */
        @media (max-width: 767px) {
            #inventory { position: absolute; bottom: 0; left: 0; right: 0; height: calc(130px + var(--safe-bottom)); background: var(--glass); backdrop-filter: blur(10px); border-top: 1px solid #ddd; display: flex; overflow-x: auto; padding: 15px; gap: 12px; align-items: center; z-index: 100; }
            #board { bottom: calc(130px + var(--safe-bottom)); }
        }
        @media (min-width: 768px) {
            #inventory { position: absolute; top: 0; right: 0; width: 320px; height: 100%; background: #f8f9fa; border-left: 2px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; gap: 10px; z-index: 100; }
            #board { right: 320px; }
        }

        /* Items */
        .item { position: absolute; padding: 12px 20px; background: white; border: 1px solid #ddd; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.2rem; display: flex; align-items: center; gap: 10px; z-index: 10; cursor: grab; white-space: nowrap; touch-action: none; user-select: none; }
        .inv-item { padding: 12px 20px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: grab; white-space: nowrap; flex-shrink: 0; transition: 0.2s; font-weight: 500; }
        .inv-item:hover { transform: scale(1.05); border-color: var(--primary); }

        /* HUD & UI */
        .menu-btn { width: 280px; padding: 18px; margin: 10px; font-size: 1.2rem; border: none; border-radius: 15px; cursor: pointer; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; }
        .special { background: var(--primary); color: white; }
        #goal-bar { position: fixed; top: calc(20px + var(--safe-top)); left: 50%; transform: translateX(-50%); background: white; padding: 12px 30px; border-radius: 40px; border: 3px solid var(--accent); font-weight: bold; z-index: 1000; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .corner-btn { position: fixed; z-index: 1001; width: 50px; height: 50px; background: white; border-radius: 50%; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1 style="font-size: 4rem; margin-bottom: 10px; letter-spacing: -2px;">CRAFTY üß™</h1>
        <p style="margin-bottom: 30px; color: #666;">The AI Alchemy Race</p>
        <button class="menu-btn special" onclick="startSinglePlayer()">üïπÔ∏è Single Player</button>
        <button class="menu-btn" onclick="showScreen('screen-multi')">üë• Multiplayer Race</button>
        <button class="menu-btn" onclick="resetGame()" style="color:red; font-size: 0.8rem; margin-top: 20px;">Clear Data</button>
    </div>

    <div id="screen-multi" class="screen">
        <h2>Multiplayer Lobby</h2>
        <input type="text" id="room-input" placeholder="Room Code (e.g. 1234)" style="padding:15px; width:250px; border-radius:12px; border:2px solid #ddd; margin: 20px 0; font-size: 1rem;">
        <button class="menu-btn special" onclick="setupLobby('host')">üè† Host Race</button>
        <button class="menu-btn" onclick="setupLobby('join')">üîë Join Room</button>
        <button class="menu-btn" onclick="showScreen('screen-home')">‚¨ÖÔ∏è Back</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="goal-bar">GOAL: <span id="target-word">...</span></div>
        <div class="corner-btn" style="top: calc(15px + var(--safe-top)); left:15px;" onclick="location.reload()">üè†</div>
        <div class="corner-btn" style="top: calc(15px + var(--safe-top)); right:15px;" onclick="clearBoard()">üßπ</div>
        <div id="board"></div>
        <div id="inventory"></div>
    </div>

    <script>
        // API Configuration
        const GROQ_KEY = "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";
        const ABLY_KEY = "IX1oeA.YHFVAg:SzKEUf1q-Lvi5CQzI3BlCyhh2tX1fZBfxXtFyYu_-NY";

        // Game State
        const baseElements = [{n:"Water",e:"üíß"}, {n:"Fire",e:"üî•"}, {n:"Earth",e:"üåç"}, {n:"Wind",e:"üí®"}];
        let myDiscoveries = JSON.parse(localStorage.getItem('myCrafts')) || [...baseElements];
        let ably, channel, targetGoal = "", isMulti = false;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startSinglePlayer() {
            isMulti = false;
            document.getElementById('goal-bar').style.display = 'none';
            showScreen('screen-game');
            updateInventoryUI();
        }

        async function setupLobby(role) {
            const code = document.getElementById('room-input').value;
            if(!code) return alert("Please enter a room code.");
            
            ably = new Ably.Realtime(ABLY_KEY);
            channel = ably.channels.get('race-' + code);
            
            // Listen for race start and winners
            channel.subscribe('start-race', (msg) => {
                targetGoal = msg.data.n;
                document.getElementById('target-word').innerText = msg.data.e + " " + targetGoal;
                document.getElementById('goal-bar').style.display = 'block';
                isMulti = true;
                showScreen('screen-game');
                updateInventoryUI();
            });

            channel.subscribe('win', (msg) => {
                alert(`üèÅ RACE OVER! ${msg.data.winner} found ${targetGoal} first!`);
                location.reload();
            });

            if(role === 'host') {
                // Host picks a random complex goal using AI
                const goal = await fetchAI("Advanced", "Secret Object");
                channel.publish('start-race', goal);
            }
        }

        function updateInventoryUI() {
            const inv = document.getElementById('inventory');
            inv.innerHTML = '';
            myDiscoveries.sort((a,b) => a.n.localeCompare(b.n)).forEach(item => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.innerHTML = `${item.e} ${item.n}`;
                
                // Drag-from-tray logic
                div.onpointerdown = (e) => {
                    e.preventDefault();
                    const newItem = createItem(item.n, item.e, e.clientX - 50, e.clientY - 20);
                    newItem.dispatchEvent(new PointerEvent('pointerdown', e));
                };
                inv.appendChild(div);
            });
        }

        function createItem(name, emoji, x, y) {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<span>${emoji}</span> <span>${name}</span>`;
            div.style.left = x + 'px'; div.style.top = y + 'px';
            document.getElementById('board').appendChild(div);

            // Win Condition Check
            if (isMulti && name.toLowerCase() === targetGoal.toLowerCase()) {
                channel.publish('win', { winner: "A Crafter" });
            }

            // Enhanced Drag Logic
            div.onpointerdown = (e) => {
                div.setPointerCapture(e.pointerId);
                div.style.zIndex = 1000;
                let sX = e.clientX - div.offsetLeft, sY = e.clientY - div.offsetTop;

                div.onpointermove = (ev) => {
                    div.style.left = (ev.clientX - sX) + 'px';
                    div.style.top = (ev.clientY - sY) + 'px';
                    checkOverlap(div);
                };

                div.onpointerup = () => {
                    div.style.zIndex = 10;
                    div.onpointermove = null;
                    div.onpointerup = null;
                };
            };
            return div;
        }

        async function checkOverlap(active) {
            const items = document.querySelectorAll('.item');
            const r1 = active.getBoundingClientRect();
            for (let other of items) {
                if (other === active) continue;
                const r2 = other.getBoundingClientRect();
                
                if (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom)) {
                    const n1 = active.querySelector('span:last-child').innerText;
                    const n2 = other.querySelector('span:last-child').innerText;
                    const spawnX = r2.left, spawnY = r2.top;
                    
                    active.remove(); other.remove();
                    
                    const result = await fetchAI(n1, n2);
                    
                    if (!myDiscoveries.some(d => d.n === result.n)) {
                        myDiscoveries.push(result);
                        localStorage.setItem('myCrafts', JSON.stringify(myDiscoveries));
                        updateInventoryUI();
                    }
                    createItem(result.n, result.e, spawnX, spawnY);
                    break;
                }
            }
        }

        async function fetchAI(i1, i2) {
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama3-8b-8192",
                        messages: [
                            { role: "system", content: "You are an Alchemy game. Combine 2 items. Use logic, humor, or pop culture. Famous people/characters allowed. Output ONLY JSON: {\"n\":\"Name\",\"e\":\"Emoji\"}" },
                            { role: "user", content: `Combine ${i1} + ${i2}` }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.3
                    })
                });
                const data = await response.json();
                return JSON.parse(data.choices[0].message.content);
            } catch (err) {
                return { n: "Dust", e: "‚òÅÔ∏è" };
            }
        }

        function clearBoard() { document.getElementById('board').innerHTML = ''; }
        function resetGame() { if(confirm("Delete all discoveries?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
