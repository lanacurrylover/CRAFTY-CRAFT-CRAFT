<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRAFTY CRAFT CRAFT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #09090b; color: #e4e4e7; font-family: 'Inter', sans-serif; overflow: hidden; touch-action: none; -webkit-user-select: none; }
        .canvas-area { background-image: radial-gradient(#1f1f23 2px, transparent 2px); background-size: 30px 30px; position: relative; }
        .element-node { cursor: grab; touch-action: none; transition: transform 0.1s; z-index: 10; user-select: none; position: absolute; }
        .new-shine { box-shadow: 0 0 25px 5px rgba(250, 204, 21, 0.7); border: 3px solid #facc15 !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1.1); } 50% { transform: scale(1.2); } }
        .slot-btn-active { background: #facc15 !important; color: #000 !important; }
        #inventory::-webkit-scrollbar { display: none; }
        .menu-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .menu-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="screen-home" class="fixed inset-0 z-[200] bg-zinc-950 flex flex-col items-center justify-center p-6">
        <h1 class="text-6xl font-black italic text-white mb-2 tracking-tighter">CRAFTY</h1>
        <p class="text-yellow-500 font-black text-[10px] tracking-[0.3em] mb-12 uppercase">Evolution Engine</p>
        
        <div class="grid grid-cols-1 gap-4 w-full max-w-xs">
            <button onclick="startGame('single')" class="menu-btn py-6 bg-white text-black rounded-3xl font-black text-xl flex items-center justify-center gap-3 shadow-xl">
                <i data-lucide="user"></i> SINGLE PLAYER
            </button>
            <button onclick="showScreen('screen-multi-hub')" class="menu-btn py-6 bg-zinc-900 border border-white/10 text-white rounded-3xl font-black text-xl flex items-center justify-center gap-3">
                <i data-lucide="users"></i> MULTIPLAYER
            </button>
        </div>
    </div>

    <div id="screen-multi-hub" class="fixed inset-0 z-[201] bg-zinc-950 hidden flex flex-col items-center justify-center p-6">
        <button onclick="showScreen('screen-home')" class="absolute top-12 left-6 text-zinc-500 flex items-center gap-2 font-bold uppercase text-xs">
            <i data-lucide="chevron-left"></i> Back
        </button>
        <h2 class="text-3xl font-black text-white mb-8 italic uppercase tracking-tighter">Multiplayer</h2>
        
        <div class="grid grid-cols-1 gap-4 w-full max-w-xs">
            <button onclick="setupHost()" class="menu-btn py-8 bg-indigo-600 text-white rounded-3xl font-black text-lg flex flex-col items-center gap-2 shadow-[0_0_30px_rgba(79,70,229,0.3)]">
                <i data-lucide="crown" class="w-8 h-8"></i> HOST A RACE
            </button>
            <button onclick="showScreen('screen-join')" class="menu-btn py-8 bg-zinc-800 text-white rounded-3xl font-black text-lg flex flex-col items-center gap-2">
                <i data-lucide="key-round" class="w-8 h-8"></i> ENTER CODE
            </button>
        </div>
    </div>

    <div id="screen-host" class="fixed inset-0 z-[202] bg-zinc-950 hidden flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-zinc-500 font-black text-xs tracking-widest uppercase mb-2">Your Room Code</h2>
        <div id="room-code-display" class="text-7xl font-black text-yellow-500 tracking-[0.2em] mb-12">0000</div>
        <button onclick="startGame('multi')" class="menu-btn px-12 py-5 bg-white text-black rounded-full font-black text-lg uppercase shadow-2xl">
            Start Race
        </button>
        <button onclick="showScreen('screen-multi-hub')" class="mt-8 text-zinc-600 font-bold uppercase text-[10px]">Cancel</button>
    </div>

    <div id="screen-join" class="fixed inset-0 z-[203] bg-zinc-950 hidden flex flex-col items-center justify-center p-6">
        <h2 class="text-2xl font-black text-white mb-8 uppercase italic">Enter Room Code</h2>
        <input type="number" id="join-input" placeholder="0000" class="w-full max-w-[200px] bg-transparent border-b-4 border-yellow-500 py-4 text-center text-5xl font-black text-yellow-500 outline-none mb-10">
        <div class="grid grid-cols-1 w-full max-w-xs gap-3">
            <button onclick="joinGame()" class="menu-btn py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase">Join Game</button>
            <button onclick="showScreen('screen-multi-hub')" class="py-5 text-zinc-500 font-bold uppercase text-xs">Cancel</button>
        </div>
    </div>

    <nav class="h-16 border-b border-white/10 flex items-center justify-between px-4 bg-zinc-950 z-50">
        <button onclick="toggleDiscoveryModal()" class="p-2.5 bg-yellow-500/10 text-yellow-500 rounded-xl border border-yellow-500/30"><i data-lucide="trophy"></i></button>
        <div id="target-ui" class="hidden bg-indigo-500/10 border border-indigo-500/30 px-4 py-1.5 rounded-xl flex flex-col items-center">
            <span class="text-[8px] font-black text-indigo-400 uppercase">Target</span>
            <span id="target-display" class="text-sm font-black text-white">---</span>
        </div>
        <div id="slot-selector" class="flex bg-zinc-900 p-1 rounded-xl border border-white/5 scale-90">
            <button onclick="switchSlot(1)" id="slot-1" class="px-4 py-1.5 rounded-lg text-[10px] font-black">S1</button>
            <button onclick="switchSlot(2)" id="slot-2" class="px-4 py-1.5 rounded-lg text-[10px] font-black">S2</button>
            <button onclick="switchSlot(3)" id="slot-3" class="px-4 py-1.5 rounded-lg text-[10px] font-black">S3</button>
        </div>
        <button onclick="showScreen('screen-home')" class="p-2.5 bg-zinc-800 text-white rounded-xl border border-white/5"><i data-lucide="home"></i></button>
    </nav>

    <main id="canvas" class="flex-1 canvas-area overflow-hidden"></main>

    <aside class="h-48 border-t border-white/10 bg-zinc-950 flex flex-col p-4">
        <div class="flex justify-between items-center mb-4">
            <input type="text" id="slot-name-input" onchange="renameSlot()" class="bg-transparent text-yellow-500 font-black uppercase text-xs w-28 outline-none" value="SLOT 1">
            <button onclick="toggleKey()" id="key-label" class="text-[10px] font-black px-4 py-1.5 bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 rounded-full uppercase">Nature</button>
        </div>
        <div id="inventory" class="flex flex-nowrap overflow-x-auto gap-4 pb-4"></div>
    </aside>

    <div id="discovery-modal" class="fixed inset-0 z-[100] modal-bg hidden flex flex-col bg-black/90 backdrop-blur-md">
        <div class="p-6 flex justify-between items-center border-b border-white/10">
            <h2 class="text-2xl font-black italic text-white uppercase">Hall of Fame</h2>
            <button onclick="toggleDiscoveryModal()" class="p-3 bg-zinc-800 rounded-full text-white"><i data-lucide="x"></i></button>
        </div>
        <div id="discovery-list" class="p-6 grid grid-cols-3 gap-4 overflow-y-auto"></div>
    </div>

    <script>
        let currentGameMode = 'single', currentSlot = 1, activeKey = 'Nature', inventory = [];
        let targetItem = "", firstDiscoveries = JSON.parse(localStorage.getItem('crafty_first_list')) || [];
        let slotNames = JSON.parse(localStorage.getItem('crafty_slot_names')) || { 1: "SLOT 1", 2: "SLOT 2", 3: "SLOT 3" };

        const BASE = [{ name: 'Water', emoji: 'ðŸ’§' }, { name: 'Fire', emoji: 'ðŸ”¥' }, { name: 'Earth', emoji: 'ðŸ”ï¸' }, { name: 'Wind', emoji: 'ðŸŒ¬ï¸' }];
        const LOGIC = { 'Nature': { 'fire+water': 'Steam', 'fire+earth': 'Lava', 'earth+water': 'Mud', 'wind+earth': 'Dust' }, 'Music': { 'wind+fire': 'Jazz', 'water+fire': 'Blues' } };
        const EMOJIS = { 'Steam': 'â˜ï¸', 'Lava': 'ðŸŒ‹', 'Mud': 'ðŸ’©', 'Jazz': 'ðŸŽ·', 'Blues': 'ðŸŽ¸', 'Dust': 'ðŸ§¹' };

        function showScreen(screenId) {
            ['screen-home', 'screen-multi-hub', 'screen-host', 'screen-join'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function setupHost() {
            document.getElementById('room-code-display').innerText = Math.floor(1000 + Math.random() * 9000);
            showScreen('screen-host');
        }

        function joinGame() {
            const val = document.getElementById('join-input').value;
            if (val.length === 4) { startGame('multi'); } 
            else { alert("Please enter 4 digits!"); }
        }

        function startGame(mode) {
            currentGameMode = mode;
            showScreen('none'); // Hides all menu screens
            if (mode === 'multi') {
                document.getElementById('slot-selector').classList.add('hidden');
                document.getElementById('target-ui').classList.remove('hidden');
                setupRace();
            } else {
                document.getElementById('slot-selector').classList.remove('hidden');
                document.getElementById('target-ui').classList.add('hidden');
                switchSlot(currentSlot);
            }
        }

        function setupRace() {
            inventory = [...BASE];
            const keys = Object.keys(EMOJIS);
            targetItem = keys[Math.floor(Math.random() * keys.length)];
            document.getElementById('target-display').innerText = EMOJIS[targetItem] + " " + targetItem;
            resetCanvas(); render();
        }

        function switchSlot(slotNum) {
            currentSlot = slotNum;
            for(let i=1; i<=3; i++) document.getElementById(`slot-${i}`).className = (i === slotNum) ? 'slot-btn-active px-4 py-1.5 rounded-lg text-[10px] font-black' : 'px-4 py-1.5 rounded-lg text-[10px] font-black text-zinc-500';
            document.getElementById('slot-name-input').value = slotNames[slotNum];
            inventory = JSON.parse(localStorage.getItem(`crafty_data_slot_${slotNum}`)) || [...BASE];
            resetCanvas(); render();
        }

        function render() {
            const list = document.getElementById('inventory');
            list.innerHTML = '';
            inventory.forEach(item => {
                const card = document.createElement('div');
                card.className = "flex-shrink-0 bg-zinc-900 border border-white/10 p-5 rounded-2xl flex flex-col items-center justify-center min-w-[100px]";
                card.onclick = () => spawn(item.name, item.emoji, window.innerWidth/2, window.innerHeight/3);
                card.innerHTML = `<span class="text-4xl mb-1">${item.emoji}</span><span class="text-[10px] font-black uppercase text-zinc-400">${item.name}</span>`;
                list.appendChild(card);
            });
        }

        function spawn(name, emoji, x, y, isNew = false) {
            const el = document.createElement('div');
            el.className = `element-node bg-white text-black px-6 py-3 rounded-full font-black shadow-2xl flex items-center gap-2 ${isNew ? 'new-shine' : ''}`;
            el.style.left = (x - 60) + 'px'; el.style.top = (y - 25) + 'px';
            el.dataset.name = name; el.innerHTML = `<span>${emoji}</span> ${name}`;
            el.ontouchmove = (e) => { el.style.left = (e.touches[0].clientX - 60) + 'px'; el.style.top = (e.touches[0].clientY - 25) + 'px'; };
            el.ontouchend = () => check(el);
            document.getElementById('canvas').appendChild(el);
        }

        function check(active) {
            document.querySelectorAll('.element-node').forEach(other => {
                if (other === active) return;
                const r1 = active.getBoundingClientRect(), r2 = other.getBoundingClientRect();
                if (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom)) {
                    const pair = [active.dataset.name.toLowerCase(), other.dataset.name.toLowerCase()].sort().join('+');
                    const match = LOGIC[activeKey][pair];
                    if (match) {
                        const alreadyHad = inventory.find(i => i.name === match);
                        if (!alreadyHad) {
                            inventory.push({ name: match, emoji: EMOJIS[match] });
                            if (!firstDiscoveries.find(d => d.name === match)) firstDiscoveries.push({ name: match, emoji: EMOJIS[match] });
                            render(); 
                            if(currentGameMode === 'single') manualSave();
                        }
                        active.remove(); other.remove();
                        spawn(match, EMOJIS[match], r1.left + 50, r1.top, true);
                        if(currentGameMode === 'multi' && match === targetItem) {
                            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                            setTimeout(() => { alert("WINNER!"); setupRace(); }, 500);
                        } else {
                            confetti({ particleCount: 50, spread: 40 });
                        }
                    }
                }
            });
        }

        function manualSave() {
            localStorage.setItem(`crafty_data_slot_${currentSlot}`, JSON.stringify(inventory));
            localStorage.setItem('crafty_slot_names', JSON.stringify(slotNames));
            localStorage.setItem('crafty_first_list', JSON.stringify(firstDiscoveries));
        }

        function renameSlot() { slotNames[currentSlot] = document.getElementById('slot-name-input').value.toUpperCase(); manualSave(); }
        function toggleDiscoveryModal() {
            const m = document.getElementById('discovery-modal'); m.classList.toggle('hidden');
            const l = document.getElementById('discovery-list'); l.innerHTML = '';
            firstDiscoveries.forEach(i => { l.innerHTML += `<div class="bg-zinc-900 border border-yellow-500/30 p-4 rounded-2xl flex flex-col items-center"><span class="text-4xl">${i.emoji}</span><span class="text-[9px] font-black uppercase text-white mt-1">${i.name}</span></div>`; });
        }
        function toggleKey() { activeKey = activeKey === 'Nature' ? 'Music' : 'Nature'; document.getElementById('key-label').innerText = activeKey; }
        function resetCanvas() { document.getElementById('canvas').innerHTML = ''; }
        
        lucide.createIcons();
    </script>
</body>
</html>
