<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRAFTY AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; touch-action: none; }
        .canvas-area { background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 30px 30px; position: relative; height: 100%; width: 100%; flex: 1; }
        .element-node { cursor: grab; touch-action: none; position: absolute; white-space: nowrap; border-radius: 12px; z-index: 10; padding: 10px 20px; background: white; color: black; font-weight: 900; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 1px solid #ddd; }
        .inventory-item { background: #111; border: 1px solid #222; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <nav class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-black z-50">
        <span class="font-black italic text-xl tracking-tighter text-yellow-500">CRAFTY AI</span>
        <button onclick="location.reload()" class="text-zinc-500 text-xs font-bold uppercase tracking-widest">Reset Canvas</button>
    </nav>
    <main id="canvas" class="canvas-area"></main>
    <aside class="h-1/3 border-t border-white/10 bg-zinc-950 p-4">
        <div id="inventory" class="flex flex-wrap gap-2 overflow-y-auto h-full content-start justify-center pb-8"></div>
    </aside>

    <script>
        let myItems = JSON.parse(localStorage.getItem('crafty_save')) || [
            { n: 'Water', e: 'üíß' }, { n: 'Fire', e: 'üî•' }, { n: 'Earth', e: 'üåç' }, { n: 'Wind', e: 'üå¨Ô∏è' }
        ];

        function render() {
            const inv = document.getElementById('inventory');
            inv.innerHTML = '';
            myItems.forEach(item => {
                const btn = document.createElement('div');
                btn.className = "inventory-item";
                btn.innerHTML = `${item.e} ${item.n}`;
                btn.onclick = () => spawn(item.n, item.e, window.innerWidth/2, window.innerHeight/4);
                inv.appendChild(btn);
            });
            localStorage.setItem('crafty_save', JSON.stringify(myItems));
        }

        function spawn(name, emoji, x, y) {
            const el = document.createElement('div');
            el.className = "element-node";
            el.style.left = x + 'px'; el.style.top = y + 'px';
            el.innerHTML = `<span>${emoji}</span> ${name}`;
            el.dataset.name = name; el.dataset.emoji = emoji;

            let isDragging = false;
            const move = (e) => {
                if(!isDragging) return;
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                el.style.left = (cx - 50) + 'px'; el.style.top = (cy - 20) + 'px';
            };
            el.onmousedown = el.ontouchstart = () => isDragging = true;
            window.onmousemove = window.ontouchmove = move;
            window.onmouseup = window.ontouchend = () => { if(isDragging) checkMerge(el); isDragging = false; };
            document.getElementById('canvas').appendChild(el);
        }

        async function checkMerge(active) {
            const r1 = active.getBoundingClientRect();
            const other = Array.from(document.querySelectorAll('.element-node')).find(node => {
                if (node === active) return false;
                const r2 = node.getBoundingClientRect();
                return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
            });

            if (other) {
                const item1 = active.dataset.name;
                const item2 = other.dataset.name;
                active.innerHTML = "<span>‚è≥</span> Thinking...";
                
                try {
                    const res = await fetch('/.netlify/functions/craft', {
                        method: 'POST',
                        body: JSON.stringify({ item1, item2 })
                    });
                    const data = await res.json();
                    if (!myItems.find(i => i.n === data.n)) {
                        myItems.push(data);
                        render();
                    }
                    const ox = other.offsetLeft, oy = other.offsetTop;
                    active.remove(); other.remove();
                    spawn(data.n, data.e, ox, oy);
                    confetti({ particleCount: 40 });
                } catch (e) { active.innerHTML = `<span>${active.dataset.emoji}</span> ${active.dataset.name}`; }
            }
        }
        render();
    </script>
</body>
</html>
