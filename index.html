<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRAFTY: LIVE CONNECT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; touch-action: none; }
        .canvas-area { background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 30px 30px; position: relative; height: 100%; width: 100%; flex: 1; }
        .element-node { cursor: grab; touch-action: none; position: absolute; white-space: nowrap; border-radius: 14px; z-index: 10; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5)); }
        .menu-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); transition: all 0.2s; }
        .menu-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="home-page" class="fixed inset-0 z-[2000] bg-black flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-7xl font-black italic tracking-tighter mb-2">CRAFTY</h1>
        <p class="text-yellow-500 font-bold tracking-[0.4em] text-[10px] mb-12 uppercase">UK Multiplayer Edition</p>
        
        <div class="grid gap-4 w-full max-w-xs">
            <button onclick="startSolo()" class="bg-white text-black font-black py-4 rounded-2xl flex items-center justify-center gap-3">
                <i data-lucide="play"></i> PLAY SOLO
            </button>
            <button onclick="showScreen('multi-choice')" class="menu-btn text-white font-black py-4 rounded-2xl flex items-center justify-center gap-3">
                <i data-lucide="users"></i> MULTIPLAYER
            </button>
        </div>
    </div>

    <div id="multi-choice" class="fixed inset-0 z-[2100] hidden bg-black/95 flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-3xl font-black mb-10 uppercase italic">Multiplayer</h2>
        <div class="grid gap-4 w-full max-w-xs">
            <button onclick="setupPeer(true)" class="menu-btn p-8 rounded-3xl flex flex-col items-center gap-2 border-yellow-500/30">
                <i data-lucide="broadcast" class="text-yellow-500"></i>
                <span class="font-black text-sm">HOST A ROOM</span>
            </button>
            <button onclick="setupPeer(false)" class="menu-btn p-8 rounded-3xl flex flex-col items-center gap-2 border-blue-500/30">
                <i data-lucide="log-in" class="text-blue-500"></i>
                <span class="font-black text-sm">JOIN A ROOM</span>
            </button>
            <button onclick="showScreen('home-page')" class="mt-6 text-zinc-500 font-bold uppercase text-[10px]">Back</button>
        </div>
    </div>

    <nav class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-black z-50">
        <div class="flex items-center gap-3">
            <div id="status-light" class="status-dot bg-zinc-600"></div>
            <div class="flex flex-col">
                <span id="u-display" class="font-black uppercase text-[10px]">Crafty Player</span>
                <span id="conn-status" class="text-[7px] text-zinc-500 font-bold uppercase tracking-widest">Offline</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="p-2 text-zinc-500"><i data-lucide="home" size="18"></i></button>
            <button onclick="resetCanvas()" class="p-2 text-zinc-500"><i data-lucide="trash-2" size="18"></i></button>
        </div>
    </nav>

    <main id="canvas" class="canvas-area">
        <div id="room-tag" class="hidden absolute top-4 left-1/2 -translate-x-1/2 bg-yellow-500 text-black px-4 py-1 rounded-full text-[10px] font-black z-[100]"></div>
    </main>

    <aside class="h-1/3 border-t border-white/10 bg-zinc-950 p-4">
        <div id="inventory" class="flex flex-wrap gap-2 overflow-y-auto h-full content-start justify-center pb-8"></div>
    </aside>

    <script>
        let peer, conn;
        let myCollection = [
            { name: 'Water', emoji: 'ðŸ’§' }, { name: 'Fire', emoji: 'ðŸ”¥' }, 
            { name: 'Earth', emoji: 'ðŸ”ï¸' }, { name: 'Wind', emoji: 'ðŸŒ¬ï¸' }
        ];

        function showScreen(id) {
            document.querySelectorAll('#home-page, #multi-choice').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function startSolo() {
            showScreen('home-page'); // Hidden
            initGame();
        }

        // --- MULTIPLAYER CORE ---
        function setupPeer(isHost) {
            peer = new Peer(); // Free public cloud signaling

            peer.on('open', (id) => {
                if (isHost) {
                    const roomCode = id.substring(0, 5).toUpperCase();
                    document.getElementById('room-tag').innerText = "ROOM: " + roomCode;
                    document.getElementById('room-tag').classList.remove('hidden');
                    alert("YOUR ROOM CODE: " + roomCode + "\nGive this to your friend!");
                    initGame();
                } else {
                    const target = prompt("ENTER ROOM CODE:").toLowerCase();
                    // PeerJS IDs are longer, we find the peer by searching or exact ID
                    // For simplicity in this demo, you'd usually use the full ID
                    conn = peer.connect(target);
                    setupConn();
                    initGame();
                }
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConn();
            });
        }

        function setupConn() {
            conn.on('open', () => {
                document.getElementById('status-light').className = "status-dot bg-green-500";
                document.getElementById('conn-status').innerText = "Connected";
                confetti({ particleCount: 100 });
            });
            conn.on('data', (data) => {
                // Receive element from friend
                if (data.type === 'spawn') {
                    spawn(data.name, data.emoji, data.x, data.y, true);
                }
            });
        }

        function initGame() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('multi-choice').classList.add('hidden');
            render();
        }

        function render() {
            const inv = document.getElementById('inventory');
            inv.innerHTML = '';
            myCollection.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "bg-zinc-900 border border-white/5 text-white px-4 py-2 rounded-xl flex items-center gap-2 text-[10px] font-black uppercase shadow-lg";
                btn.innerHTML = `<span>${item.emoji}</span> ${item.name}`;
                btn.onclick = () => spawn(item.name, item.emoji, window.innerWidth/2, window.innerHeight/4);
                inv.appendChild(btn);
            });
            document.getElementById('u-count').innerText = `${myCollection.length} Discoveries`;
        }

        function spawn(name, emoji, x, y, fromFriend = false) {
            const el = document.createElement('div');
            el.className = `element-node bg-white text-black px-5 py-2.5 rounded-xl font-black flex items-center gap-2 shadow-2xl`;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            el.dataset.name = name; el.dataset.emoji = emoji;
            el.innerHTML = `<span>${emoji}</span> ${name} ${fromFriend ? 'ðŸ¤' : ''}`;
            
            const move = (e) => {
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                el.style.left = (cx - 40) + 'px'; el.style.top = (cy - 20) + 'px';
                
                // If connected, tell friend where we are moving it
                if (conn && conn.open) {
                    conn.send({ type: 'move', name, x: cx, y: cy });
                }
            };
            
            el.addEventListener('touchmove', move);
            el.addEventListener('touchend', () => checkMerge(el));
            document.getElementById('canvas').appendChild(el);
            
            // If we spawned it and have a friend, send it to them
            if (!fromFriend && conn && conn.open) {
                conn.send({ type: 'spawn', name, emoji, x, y });
            }
        }

        function checkMerge(active) {
            const r1 = active.getBoundingClientRect();
            document.querySelectorAll('.element-node').forEach(other => {
                if (other === active) return;
                const r2 = other.getBoundingClientRect();
                if (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom)) {
                    const n1 = active.dataset.name, n2 = other.dataset.name;
                    const newName = n1.substring(0,3) + n2.substring(n2.length - 3);
                    const res = { name: newName.charAt(0).toUpperCase() + newName.slice(1).toLowerCase(), emoji: 'âœ¨' };
                    
                    if (!myCollection.find(i => i.name === res.name)) {
                        myCollection.push(res);
                        render();
                    }
                    active.remove(); other.remove();
                    spawn(res.name, res.emoji, r2.left, r2.top, false);
                    confetti({ particleCount: 50 });
                }
            });
        }

        function resetCanvas() { document.getElementById('canvas').innerHTML = ''; }
        
        lucide.createIcons();
    </script>
</body>
</html>
